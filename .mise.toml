# mise configuration for bazel-aws-maven-proxy
# https://mise.jdx.dev/

[tools]
python = "3.11"

[tasks.start]
description = "Start complete system (containers + SSO watcher)"
depends = ["containers:up", "sso-install"]

[tasks.stop]
description = "Stop complete system (containers + SSO watcher)"
depends = ["containers:down", "sso-uninstall"]

[tasks."containers:up"]
description = "Start container services (s3proxy + sso-monitor)"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD up -d"

[tasks."containers:down"]
description = "Stop container services"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD down"

[tasks."containers:logs"]
description = "View container service logs"
run = "bash scripts/docker-logs.sh"

[tasks."containers:restart"]
description = "Restart container services"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD restart"

[tasks.sso-install]
description = "Install SSO watcher as macOS launchd user agent"
run = "bash scripts/sso-install.sh"

[tasks.sso-uninstall]
description = "Uninstall SSO watcher launchd agent"
run = "bash scripts/sso-uninstall.sh"

[tasks.sso-status]
description = "Check SSO watcher launchd agent status"
run = "bash scripts/sso-status.sh"

[tasks.sso-restart]
description = "Restart SSO watcher launchd agent"
run = "bash scripts/sso-restart.sh"

[tasks.sso-logs]
description = "Show recent SSO watcher logs (default 50 lines)"
run = "bash scripts/sso-logs.sh {{arg(name=\"lines\", default=\"50\")}}"

[tasks."sso-logs:follow"]
description = "Stream SSO watcher logs (Ctrl+C to stop)"
run = """
LOG_FILE="$HOME/Library/Logs/sso-watcher.log"
ERROR_LOG="$HOME/Library/Logs/sso-watcher.error.log"
echo "Streaming SSO watcher logs (Ctrl+C to exit)..."
trap 'exit 0' INT TERM
tail -f "$LOG_FILE" "$ERROR_LOG" 2>/dev/null &
wait $!
"""

[tasks.sso-logout]
description = "Logout from AWS SSO (invalidates credentials, triggers renewal)"
run = """
if [ -f .env ]; then source .env; fi
AWS_PROFILE="${AWS_PROFILE:-default}"
SIGNAL_DIR="$HOME/.aws/sso-renewer"

MODE_FILE="$SIGNAL_DIR/mode"
if [ -f "$MODE_FILE" ]; then
  MODE=$(tr -d '[:space:]' < "$MODE_FILE")
else
  MODE="${SSO_LOGIN_MODE:-notify}"
fi

echo "Logging out from AWS SSO (profile: $AWS_PROFILE)..."
aws sso logout 2>/dev/null || true

# Clear cooldown so watcher reacts immediately when monitor detects expiry
rm -f "$SIGNAL_DIR/last-login-at.txt" 2>/dev/null || true

echo "✓ Logged out — credentials invalidated"
if [ "$MODE" = "standalone" ]; then
  echo "  Login again with: mise run sso-login"
else
  echo "  Monitor will detect expiry within ${CHECK_INTERVAL:-60}s"
fi
"""

[tasks.sso-login]
description = "Trigger SSO login (signal watcher or run directly in standalone mode)"
run = """
# Load .env to get correct AWS_PROFILE
if [ -f .env ]; then source .env; fi
SIGNAL_DIR="$HOME/.aws/sso-renewer"
SIGNAL_FILE="$SIGNAL_DIR/login-required.json"
MODE_FILE="$SIGNAL_DIR/mode"
AWS_PROFILE="${AWS_PROFILE:-default}"

# Read current mode
if [ -f "$MODE_FILE" ]; then
  MODE=$(tr -d '[:space:]' < "$MODE_FILE")
else
  MODE="${SSO_LOGIN_MODE:-notify}"
fi

if [ "$MODE" = "standalone" ]; then
  echo "Mode: standalone — running aws sso login directly"
  aws sso login --profile "$AWS_PROFILE"
  echo "✓ Login complete"
else
  # Clear cooldown so dialog shows immediately
  rm -f "$SIGNAL_DIR/last-login-at.txt" 2>/dev/null || true

  echo "Creating signal file..."
  mkdir -p "$SIGNAL_DIR"

  cat > "$SIGNAL_FILE" << EOF
{
  "profile": "$AWS_PROFILE",
  "reason": "Manual trigger via mise run sso-login",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
EOF

  if [ "$MODE" = "auto" ]; then
    echo "✓ Signal created, watcher will open browser within ${SSO_POLL_SECONDS:-5}s"
  else
    echo "✓ Signal created, watcher will show dialog within ${SSO_POLL_SECONDS:-5}s"
  fi
  echo "  Check logs: mise run sso-logs"
fi
"""

[tasks.sso-mode]
description = "Show current SSO watcher mode"
run = """
MODE_FILE="$HOME/.aws/sso-renewer/mode"
if [ -f "$MODE_FILE" ]; then
  MODE=$(cat "$MODE_FILE" | tr -d '[:space:]')
else
  if [ -f .env ]; then source .env; fi
  MODE="${SSO_LOGIN_MODE:-notify}"
fi

case "$MODE" in
  standalone) DESC="idle, manual login only" ;;
  auto)       DESC="opens browser on expiry" ;;
  notify)     DESC="asks before opening browser" ;;
  *)          DESC="unknown" ;;
esac

echo "Current mode: $MODE — $DESC"
echo ""
echo "Available modes:"
echo "  notify      asks before opening browser (default)"
echo "  auto        opens browser immediately on expiry"
echo "  standalone  watcher idle, manual login only"
echo ""
echo "Switch with: mise run sso-mode:notify|auto|standalone"
"""

[tasks."sso-mode:notify"]
description = "Switch watcher to notify mode (dialog before login)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "notify" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to notify mode (takes effect within ${SSO_POLL_SECONDS:-5}s)"
"""

[tasks."sso-mode:auto"]
description = "Switch watcher to auto mode (open browser immediately)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "auto" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to auto mode (takes effect within ${SSO_POLL_SECONDS:-5}s)"
"""

[tasks."sso-mode:standalone"]
description = "Switch watcher to standalone mode (manual login only)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "standalone" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to standalone mode — watcher idle, use 'mise run sso-login' to login manually"
"""

[tasks.sso-clean]
description = "Clean SSO watcher state and signal files"
run = """
STATE_DIR="$HOME/.aws/sso-renewer"

echo "Cleaning SSO watcher state..."

# Remove signal files
rm -f "$STATE_DIR"/login-required*.json 2>/dev/null || true
echo "✓ Removed signal files"

# Remove lock directory
rm -rf "$STATE_DIR/login.lock" 2>/dev/null || true
echo "✓ Removed lock"

# Optionally remove last-run timestamp (uncomment if needed)
# rm -f "$STATE_DIR/last-login-at.txt" 2>/dev/null || true
# echo "✓ Removed last-run timestamp"

echo ""
echo "State cleaned"
"""
