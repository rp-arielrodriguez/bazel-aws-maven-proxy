# mise configuration for bazel-aws-maven-proxy
# https://mise.jdx.dev/

[tools]
python = "3.11"

[tasks.start]
description = "Start complete system (containers + SSO watcher)"
depends = ["containers:up", "sso-install"]

[tasks.stop]
description = "Stop complete system (containers + SSO watcher)"
depends = ["containers:down", "sso-uninstall"]

[tasks."containers:up"]
description = "Start container services (s3proxy + sso-monitor)"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD up -d"

[tasks."containers:down"]
description = "Stop container services"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD down"

[tasks."containers:logs"]
description = "View container service logs"
run = "bash scripts/docker-logs.sh"

[tasks."containers:restart"]
description = "Restart container services"
run = "source scripts/container-engine.sh && eval $COMPOSE_CMD restart"

[tasks.sso-install]
description = "Install SSO watcher as macOS launchd user agent"
run = "bash scripts/sso-install.sh"

[tasks.sso-uninstall]
description = "Uninstall SSO watcher launchd agent"
run = "bash scripts/sso-uninstall.sh"

[tasks.sso-status]
description = "Check SSO watcher launchd agent status"
run = "bash scripts/sso-status.sh"

[tasks.sso-restart]
description = "Restart SSO watcher launchd agent"
run = "bash scripts/sso-restart.sh"

[tasks.sso-logs]
description = "Tail SSO watcher logs"
run = "bash scripts/sso-logs.sh"

[tasks.sso-login]
description = "Trigger SSO login (creates signal to wake the watcher)"
run = """
# Load .env to get correct AWS_PROFILE
if [ -f .env ]; then source .env; fi
SIGNAL_DIR="$HOME/.aws/sso-renewer"
SIGNAL_FILE="$SIGNAL_DIR/login-required.json"
AWS_PROFILE="${AWS_PROFILE:-default}"

# Clear cooldown so dialog shows immediately
rm -f "$SIGNAL_DIR/last-login-at.txt" 2>/dev/null || true

echo "Creating signal file..."
mkdir -p "$SIGNAL_DIR"

cat > "$SIGNAL_FILE" << EOF
{
  "profile": "$AWS_PROFILE",
  "reason": "Manual trigger via mise run sso-login",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
EOF

echo "✓ Signal created, watcher will show login dialog within 5 seconds."
echo "  Check logs: mise run sso-logs"
"""

[tasks.sso-mode]
description = "Show current SSO watcher mode"
run = """
MODE_FILE="$HOME/.aws/sso-renewer/mode"
if [ -f "$MODE_FILE" ]; then
  MODE=$(cat "$MODE_FILE" | tr -d '[:space:]')
  echo "Current mode: $MODE (from state file)"
else
  if [ -f .env ]; then source .env; fi
  MODE="${SSO_LOGIN_MODE:-notify}"
  echo "Current mode: $MODE (from env/default, no state file)"
fi
echo ""
echo "Available modes:"
echo "  notify     - Show dialog before login (default)"
echo "  auto       - Open browser immediately"
echo "  standalone - Watcher idle, manual login only"
echo ""
echo "Switch with: mise run sso-mode:notify|auto|standalone"
"""

[tasks."sso-mode:notify"]
description = "Switch watcher to notify mode (dialog before login)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "notify" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to notify mode (takes effect within ${SSO_POLL_SECONDS:-5}s)"
"""

[tasks."sso-mode:auto"]
description = "Switch watcher to auto mode (open browser immediately)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "auto" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to auto mode (takes effect within ${SSO_POLL_SECONDS:-5}s)"
"""

[tasks."sso-mode:standalone"]
description = "Switch watcher to standalone mode (manual login only)"
run = """
mkdir -p "$HOME/.aws/sso-renewer"
echo "standalone" > "$HOME/.aws/sso-renewer/mode"
echo "✓ Switched to standalone mode — watcher idle, use 'mise run sso-login' to login manually"
"""

[tasks.sso-clean]
description = "Clean SSO watcher state and signal files"
run = """
STATE_DIR="$HOME/.aws/sso-renewer"

echo "Cleaning SSO watcher state..."

# Remove signal files
rm -f "$STATE_DIR"/login-required*.json 2>/dev/null || true
echo "✓ Removed signal files"

# Remove lock directory
rm -rf "$STATE_DIR/login.lock" 2>/dev/null || true
echo "✓ Removed lock"

# Optionally remove last-run timestamp (uncomment if needed)
# rm -f "$STATE_DIR/last-login-at.txt" 2>/dev/null || true
# echo "✓ Removed last-run timestamp"

echo ""
echo "State cleaned"
"""
